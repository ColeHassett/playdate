<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gin + HTMX Example</title>
    <script
      src="https://unpkg.com/htmx.org@latest"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container text-center">
      <div class="row text-center">
        <h1>Gin + HTMX Todo List</h1>
      </div>

      <div class="row">
        <form hx-post="/player" hx-target="#players-list" hx-swap="beforeend">
          <input
            type="text"
            name="name"
            placeholder="player name..."
            required
          />
          <button type="submit">Create Player</button>
        </form>
        <ul id="players-list">
          {{ range .Players }} {{ template "player-item.html" . }} {{ end }}
        </ul>
      </div>

      <div class="row">
        <form
          class="row"
          hx-post="/playdate"
          hx-target="#playdate-list"
          hx-swap="beforeend"
        >
          <input
            type="text"
            name="game"
            placeholder="What game are you going to play?"
            required
          />
          <input
            type="datetime-local"
            name="datetime"
            placeholder="What time would you like to play?"
            required
          />
          <button type="submit">Create PlayDate</button>
        </form>
        <ul id="playdate-list">
          {{ range .PlayDates }} {{ template "playdate-item.html" . }} {{ end }}
        </ul>
      </div>

      <h1>Push Notification Example</h1>
      <p>
        This demonstrates push notifications using Go, HTMX, and Service
        Workers.
      </p>

      <button id="enableNotifications" onclick="enablePushNotifications()">
        Enable Notifications
      </button>

      <div id="status">
        <p>
          Notification Status:
          <span id="notification-state">Not requested</span>
        </p>
        <p>
          Push Subscription Status:
          <span id="push-subscription-state">Not subscribed</span>
        </p>
      </div>

      <h2>Send Test Notification (Backend Trigger)</h2>
      <p>
        This button simulates sending a push notification from the backend to
        all subscribed clients.
      </p>
      <button hx-get="/send-notification" hx-trigger="click">
        Send Test Notification
      </button>
    </div>

    <!-- <script> -->
    <!--   function subscribe() { -->
    <!--     navigator.serviceWorker.ready -->
    <!--       .then(function (registration) { -->
    <!--         const vapidPublicKey = -->
    <!--           "BLWWomxkvsI_TrblWIU8OjVKinMWPEEAOg2uS0XnbBnPJx2fJp16BL8Qy_8tPEzKQjUfs8ajScIM7pZ7aerLMqI"; -->
    <!---->
    <!--         return registration.pushManager.subscribe({ -->
    <!--           userVisibleOnly: true, -->
    <!--           applicationServerKey: urlBase64ToUint8Array(vapidPublicKey), -->
    <!--         }); -->
    <!--       }) -->
    <!--       .then(function (subscription) { -->
    <!--         console.log( -->
    <!--           JSON.stringify({ -->
    <!--             subscription: subscription, -->
    <!--           }), -->
    <!--         ); -->
    <!--       }) -->
    <!--       .catch((err) => console.error(err)); -->
    <!--   } -->
    <!---->
    <!--   function urlBase64ToUint8Array(base64String) { -->
    <!--     const padding = "=".repeat((4 - (base64String.length % 4)) % 4); -->
    <!--     const base64 = (base64String + padding) -->
    <!--       .replace(/\-/g, "+") -->
    <!--       .replace(/_/g, "/"); -->
    <!--     const rawData = window.atob(base64); -->
    <!--     return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0))); -->
    <!--   } -->
    <!---->
    <!--   if ("serviceWorker" in navigator) { -->
    <!--     navigator.serviceWorker.register("service-worker.js", { scope: "/" }); -->
    <!--     navigator.serviceWorker.ready -->
    <!--       .then(function (registration) { -->
    <!--         return registration.pushManager.getSubscription(); -->
    <!--       }) -->
    <!--       .then(function (subscription) { -->
    <!--         if (!subscription) { -->
    <!--           subscribe(); -->
    <!--         } else { -->
    <!--           console.log( -->
    <!--             JSON.stringify({ -->
    <!--               subscription: subscription, -->
    <!--             }), -->
    <!--           ); -->
    <!--         } -->
    <!--       }); -->
    <!--   } -->
    <!-- </script> -->

    <script>
      // REPLACE WITH YOUR ACTUAL VAPID PUBLIC KEY FROM THE GO BACKEND
      const VAPID_PUBLIC_KEY =
        "BLWWomxkvsI_TrblWIU8OjVKinMWPEEAOg2uS0XnbBnPJx2fJp16BL8Qy_8tPEzKQjUfs8ajScIM7pZ7aerLMqI";

      // Function to convert VAPID public key string to Uint8Array
      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, "+")
          .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function enablePushNotifications() {
        const notificationStateSpan =
          document.getElementById("notification-state");
        const pushSubscriptionStateSpan = document.getElementById(
          "push-subscription-state",
        );
        const enableButton = document.getElementById("enableNotifications");

        // 1. Check if notifications are supported
        // if (
        //   !("Notification" in window) ||
        //   !("serviceWorker" in navigator) ||
        //   !("PushManager" in window)
        // ) {
        //   notificationStateSpan.textContent =
        //     "Notifications or Push API not supported in this browser.";
        //   enableButton.disabled = true;
        //   return;
        // }

        notificationStateSpan.textContent = `Permission: ${Notification.permission}`;

        // 2. Request Notification Permission
        if (Notification.permission === "default") {
          try {
            const permission = await Notification.requestPermission();
            notificationStateSpan.textContent = `Permission: ${permission}`;
            if (permission !== "granted") {
              pushSubscriptionStateSpan.textContent = "Permission denied.";
              return;
            }
          } catch (error) {
            console.error("Error requesting notification permission:", error);
            notificationStateSpan.textContent = "Error requesting permission.";
            return;
          }
        } else if (Notification.permission === "denied") {
          notificationStateSpan.textContent =
            "Permission: Denied. Please enable notifications in your browser settings.";
          enableButton.disabled = true;
          return;
        }

        // 3. Register Service Worker
        try {
          const registration = await navigator.serviceWorker.register(
            "/static/service-worker.js",
          );
          console.log("Service Worker registered:", registration);

          // 4. Subscribe to Push Manager
          const subscribeOptions = {
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
          };

          console.log(
            "Public Key being passed to subscribe:",
            VAPID_PUBLIC_KEY,
          );
          console.log(
            "Uint8Array generated:",
            urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
          );
          const subscription =
            await registration.pushManager.subscribe(subscribeOptions);
          console.log("Push Subscription:", subscription);
          pushSubscriptionStateSpan.textContent = "Subscribed!";

          // 5. Send subscription to your Go backend using HTMX
          const subscriptionJson = subscription.toJSON();
          console.log("Subscription JSON:", subscriptionJson);

          try {
            const response = await fetch("/subscribe", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(subscriptionJson),
            });

            if (response.ok) {
              console.log("Subscription sent to backend successfully!");
              // Optionally update status based on backend response
              const responseText = await response.text();
              console.log("Backend response:", responseText);
            } else {
              console.error(
                "Failed to send subscription to backend:",
                response.status,
                response.statusText,
              );
              const errorText = await response.text();
              console.error("Backend error details:", errorText);
              pushSubscriptionStateSpan.textContent =
                "Failed to send subscription to backend.";
            }
          } catch (error) {
            console.error(
              "Network error sending subscription to backend:",
              error,
            );
            pushSubscriptionStateSpan.textContent =
              "Network error sending subscription.";
          }

          enableButton.disabled = true; // Disable after successful subscription
        } catch (error) {
          console.error("Error during push subscription:", error);
          pushSubscriptionStateSpan.textContent = "Error during subscription.";
          if (error.name === "NotAllowedError") {
            notificationStateSpan.textContent =
              "Permission blocked or denied by user gesture requirement.";
          }
        }
      }

      // Check initial state on page load
      document.addEventListener("DOMContentLoaded", () => {
        if ("Notification" in window) {
          document.getElementById("notification-state").textContent =
            `Permission: ${Notification.permission}`;
          if (Notification.permission === "granted") {
            document.getElementById("enableNotifications").disabled = true;
            // Attempt to subscribe if already granted and not subscribed
            navigator.serviceWorker.ready.then((registration) => {
              registration.pushManager
                .getSubscription()
                .then((subscription) => {
                  if (subscription) {
                    document.getElementById(
                      "push-subscription-state",
                    ).textContent = "Already subscribed!";
                  } else {
                    enablePushNotifications(); // Try to subscribe if not already
                  }
                });
            });
          } else if (Notification.permission === "denied") {
            document.getElementById("enableNotifications").disabled = true;
            document.getElementById("notification-state").textContent =
              "Permission: Denied. Please enable notifications in your browser settings.";
          }
        } else {
          document.getElementById("notification-state").textContent =
            "Notifications not supported.";
          document.getElementById("enableNotifications").disabled = true;
        }
      });
    </script>
  </body>
</html>
